<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TDSP â€” Test Data Standardization Platform</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#08090c;--card:#0f1117;--elevated:#161820;--input:#111318;
  --border:#1c1f2a;--border2:#2a2e3a;
  --t1:#e8ecf4;--t2:#8a92a6;--t3:#505668;
  --accent:#e8590c;--accent2:#ff6b1a;
  --pass:#22c55e;--pass-bg:#0a1f14;--pass-b:#14532d;
  --fail:#ef4444;--fail-bg:#1f0a0a;--fail-b:#7f1d1d;
  --cond:#eab308;--cond-bg:#1f1a0a;--cond-b:#713f12;
  --blue:#3b82f6;--purple:#a855f7;
  --mono:'JetBrains Mono',monospace;
  --sans:'DM Sans','Noto Sans KR',sans-serif;
  --kr:'Noto Sans KR','DM Sans',sans-serif;
}
html{scroll-behavior:smooth}
body{font-family:var(--kr);background:var(--bg);color:var(--t1);line-height:1.5;min-height:100vh;-webkit-font-smoothing:antialiased}
input,select,textarea,button{font-family:inherit}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes spin{to{transform:rotate(360deg)}}

/* Header */
.hdr{position:sticky;top:0;z-index:100;background:rgba(8,9,12,.88);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);padding:0 24px;height:54px;display:flex;align-items:center;justify-content:space-between}
.logo{display:flex;align-items:center;gap:9px}
.logo svg{color:var(--accent)}
.logo b{font-family:var(--sans);font-size:16px;color:var(--accent);letter-spacing:-.03em}
.logo span{color:var(--t3);font-size:12px}
.nav{display:flex;align-items:center;gap:3px}
.nbtn{display:flex;align-items:center;gap:5px;padding:6px 13px;background:0;border:1px solid transparent;border-radius:6px;color:var(--t3);font-size:12.5px;font-weight:500;cursor:pointer;transition:.15s}
.nbtn:hover{color:var(--t2);background:var(--elevated)}
.nbtn.on{color:var(--t1);background:var(--elevated);border-color:var(--border)}
.nbtn svg{width:15px;height:15px}
.ubtn{display:flex;align-items:center;gap:5px;padding:7px 15px;background:linear-gradient(135deg,var(--accent),#c2410c);border:0;border-radius:7px;color:#fff;font-size:12.5px;font-weight:600;cursor:pointer;margin-left:8px;box-shadow:0 2px 10px #e8590c33;transition:.15s}
.ubtn:hover{transform:translateY(-1px);box-shadow:0 4px 16px #e8590c44}
.ubtn svg{width:15px;height:15px}

/* Main */
.main{max-width:1260px;margin:0 auto;padding:24px}

/* Banner */
.banner{display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:7px;font-size:12.5px;margin-bottom:18px;animation:fadeUp .3s ease}
.banner.ok{background:var(--pass-bg);border:1px solid var(--pass-b);color:var(--pass)}
.banner.err{background:var(--fail-bg);border:1px solid var(--fail-b);color:var(--fail)}
.banner.info{background:#0a1530;border:1px solid #1e3a5f;color:var(--blue)}

/* Stats */
.stats{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px}
.st{background:var(--card);border:1px solid var(--border);border-radius:9px;padding:16px 18px;animation:fadeUp .4s ease both}
.st:nth-child(2){animation-delay:.05s}.st:nth-child(3){animation-delay:.1s}.st:nth-child(4){animation-delay:.15s}.st:nth-child(5){animation-delay:.2s}
.st-l{font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--t3);margin-bottom:4px;font-weight:500}
.st-v{font-family:var(--sans);font-size:28px;font-weight:700;letter-spacing:-.04em}

/* Toolbar */
.toolbar{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;align-items:center}
.dlbtn{display:flex;align-items:center;gap:5px;padding:7px 12px;background:var(--elevated);border:1px solid var(--border);border-radius:6px;color:var(--t2);font-size:12px;font-weight:500;cursor:pointer;transition:.15s}
.dlbtn:hover{border-color:var(--accent);color:var(--accent)}
.dlbtn svg{width:13px;height:13px}

/* Search */
.sbar{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.swrap{display:flex;align-items:center;gap:8px;background:var(--input);border:1px solid var(--border);border-radius:7px;padding:0 12px;flex:1 1 260px;transition:.2s}
.swrap:focus-within{border-color:var(--accent)}
.swrap svg{color:var(--t3);width:15px;height:15px;flex-shrink:0}
.sinput{background:0;border:0;outline:0;color:var(--t1);padding:10px 0;font-size:12.5px;width:100%}
.sinput::placeholder{color:var(--t3)}
.fsel{background:var(--input);border:1px solid var(--border);border-radius:7px;color:var(--t2);padding:10px 12px;font-size:12.5px;cursor:pointer;outline:0}
.vtog{display:flex;border:1px solid var(--border);border-radius:7px;overflow:hidden}
.vtog button{padding:8px 10px;background:var(--input);border:0;color:var(--t3);cursor:pointer;display:flex;transition:.15s}
.vtog button.on{background:var(--elevated);color:var(--t1)}
.vtog button svg{width:15px;height:15px}
.rcnt{color:var(--t3);font-size:11.5px;margin-bottom:12px}

/* Badges */
.bdg{display:inline-flex;align-items:center;gap:3px;padding:2px 9px;border-radius:5px;font-size:11px;font-weight:600;letter-spacing:.02em}
.bdg svg{width:11px;height:11px}
.bdg-p{background:var(--pass-bg);color:var(--pass);border:1px solid var(--pass-b)}
.bdg-f{background:var(--fail-bg);color:var(--fail);border:1px solid var(--fail-b)}
.bdg-c{background:var(--cond-bg);color:var(--cond);border:1px solid var(--cond-b)}
.fmt{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:4px;font-size:10.5px;font-weight:500}
.fmt-ppt{background:#1a1230;color:#c084fc;border:1px solid #581c87}
.fmt-xls{background:#0a1f14;color:#4ade80;border:1px solid #14532d}
.fmt-doc{background:#0a1530;color:#60a5fa;border:1px solid #1e3a5f}

/* Card Grid */
.cgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:11px}
.tcard{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:.2s;animation:fadeUp .35s ease both}
.tcard:nth-child(2){animation-delay:.04s}.tcard:nth-child(3){animation-delay:.08s}.tcard:nth-child(4){animation-delay:.12s}
.tcard:hover{border-color:var(--border2);transform:translateY(-2px);box-shadow:0 6px 20px #0006}
.ch{display:flex;justify-content:space-between;align-items:start;margin-bottom:8px}
.ct{font-size:13.5px;font-weight:600;font-family:var(--mono);margin-bottom:1px}
.cs{font-size:11.5px;color:var(--t3)}
.cm{display:flex;gap:6px;align-items:center;margin-bottom:10px;flex-wrap:wrap;font-size:11.5px;color:var(--t3)}
.cm .sep{color:var(--border)}
.mrow{display:flex;justify-content:space-between;padding:2px 0;font-size:11.5px;color:var(--t3)}
.mval{font-family:var(--mono);font-size:11px}
.tags{display:flex;gap:4px;flex-wrap:wrap}
.tag{padding:2px 8px;border-radius:9px;font-size:10px;font-weight:500;background:var(--bg);color:var(--t3);border:1px solid var(--border)}

/* Table */
.twrap{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow-x:auto;animation:fadeUp .35s ease}
.dtbl{width:100%;border-collapse:collapse}
.dtbl th{padding:11px 14px;text-align:left;color:var(--t3);font-size:10px;text-transform:uppercase;letter-spacing:.06em;font-weight:500;border-bottom:1px solid var(--border);white-space:nowrap}
.dtbl td{padding:12px 14px;font-size:12.5px;border-bottom:1px solid #12141c;white-space:nowrap}
.dtbl tbody tr{cursor:pointer;transition:.1s}
.dtbl tbody tr:hover{background:var(--elevated)}

/* Detail */
.dbk{display:inline-flex;align-items:center;gap:5px;background:0;border:0;color:var(--accent);font-size:12.5px;cursor:pointer;padding:0;margin-bottom:18px;font-weight:500}
.dbk:hover{color:var(--accent2)}
.dh{display:flex;align-items:center;gap:12px;margin-bottom:24px;flex-wrap:wrap}
.dh h2{font-family:var(--mono);font-size:20px;font-weight:700}
.dgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.dsec{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:20px}
.dsec.full{grid-column:1/-1}
.stit{font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--t3);font-weight:600;margin-bottom:12px}
.irow{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #12141c;font-size:12.5px}
.irow:last-child{border-bottom:0}
.ilbl{color:var(--t3)}.ival{color:var(--t1)}.ival.m{font-family:var(--mono);font-size:12px}
.mtbl{width:100%;border-collapse:collapse}
.mtbl th{padding:7px 10px;text-align:left;color:var(--t3);font-size:10px;text-transform:uppercase;letter-spacing:.05em;font-weight:500;border-bottom:1px solid var(--border)}
.mtbl td{padding:9px 10px;font-size:12.5px;border-bottom:1px solid #12141c}
.flink{display:flex;align-items:center;gap:7px;padding:7px 0;color:var(--blue);font-size:12.5px;cursor:pointer;border-bottom:1px solid #12141c}
.flink:last-child{border-bottom:0}
.ntxt{color:var(--t2);font-size:13px;line-height:1.7}

/* Modal */
.moverlay{position:fixed;inset:0;background:#000b;backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:1000;animation:fadeIn .2s}
.moverlay.show{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-radius:14px;width:92%;max-width:720px;max-height:88vh;overflow:auto;box-shadow:0 20px 50px #0008}
.mhdr{padding:16px 22px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.mhdr h3{font-family:var(--sans);font-size:15px;font-weight:600}
.mcls{background:0;border:0;color:var(--t3);font-size:17px;cursor:pointer;padding:4px}
.mbody{padding:22px}
.fg{margin-bottom:14px}
.fl{display:block;font-size:12px;color:var(--t2);margin-bottom:4px;font-weight:500}
.fi{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--t1);padding:9px 12px;font-size:12.5px;outline:0;transition:.2s}
.fi:focus{border-color:var(--accent)}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.fta{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--t1);padding:9px 12px;font-size:12px;outline:0;min-height:70px;resize:vertical;font-family:var(--mono)}
.fsub{width:100%;padding:12px;background:linear-gradient(135deg,var(--accent),#c2410c);border:0;border-radius:7px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;margin-top:6px;transition:.15s}
.fsub:hover{transform:translateY(-1px)}
.fsub:disabled{opacity:.5;cursor:not-allowed;transform:none}

/* Config */
.csec{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:22px;animation:fadeUp .4s ease}
.clbl{display:block;font-size:12.5px;color:var(--t2);margin-bottom:5px;font-weight:500}
.cinp{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--t1);padding:9px 12px;font-size:12.5px;outline:0;margin-bottom:12px;font-family:var(--mono);transition:.2s}
.cinp:focus{border-color:var(--accent)}
.chint{font-size:11px;color:var(--t3);margin-top:-6px;margin-bottom:12px;line-height:1.5}
.cbtn{padding:10px 22px;background:linear-gradient(135deg,var(--accent),#c2410c);border:0;border-radius:7px;color:#fff;font-size:13px;font-weight:600;cursor:pointer}

/* Schema */
.sctbl{width:100%;border-collapse:collapse}
.sctbl th{padding:9px 12px;text-align:left;color:var(--t3);font-size:10px;text-transform:uppercase;letter-spacing:.06em;font-weight:500;border-bottom:1px solid var(--border)}
.sctbl td{padding:10px 12px;font-size:12.5px;border-bottom:1px solid #12141c}
.scf{color:var(--accent);font-family:var(--mono);font-size:12px}
.sct{display:inline-block;padding:2px 8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;font-size:10.5px;color:var(--t2)}
.scr{color:var(--accent);font-size:11px}

/* Pipeline */
.pflow{display:flex;align-items:center;justify-content:center;gap:6px;flex-wrap:wrap;padding:16px 0}
.pstep{background:var(--bg);border:1px solid var(--border);border-radius:11px;padding:22px 18px;text-align:center;min-width:130px;transition:.2s}
.pstep:hover{transform:translateY(-2px);border-color:var(--border2)}
.pico{font-size:30px;margin-bottom:8px}
.ptit{font-size:12.5px;font-weight:600;margin-bottom:3px}
.pdsc{font-size:10.5px;color:var(--t3);line-height:1.4}
.parr{color:var(--border);font-size:20px}

/* Arch */
.agrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:16px}
.acard{background:var(--bg);border:1px solid var(--border);border-radius:9px;padding:18px}
.atit{font-size:12.5px;font-weight:600;margin-bottom:6px;display:flex;align-items:center;gap:7px}
.atit svg{width:15px;height:15px}
.adsc{font-size:11.5px;color:var(--t3);line-height:1.6}
.adsc code{background:var(--elevated);padding:1px 6px;border-radius:3px;font-family:var(--mono);font-size:10.5px;color:var(--accent)}
pre.codeblock{background:var(--bg);border:1px solid var(--border);border-radius:7px;padding:14px;overflow-x:auto;font-family:var(--mono);font-size:11.5px;color:var(--t2);line-height:1.7;margin-top:14px}

/* Spinner */
.spin{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;display:inline-block;vertical-align:middle}

/* Responsive */
@media(max-width:768px){
  .stats{grid-template-columns:repeat(3,1fr)}
  .dgrid,.agrid{grid-template-columns:1fr}
  .cgrid{grid-template-columns:1fr}
  .hdr{padding:0 12px}.main{padding:14px}
  .logo span{display:none}
  .pflow{flex-direction:column}.parr{transform:rotate(90deg)}
  .frow{grid-template-columns:1fr}
}
/* AI Upload */
.upload-tabs{display:flex;gap:0;margin-bottom:18px;border:1px solid var(--border);border-radius:8px;overflow:hidden}
.utab{flex:1;padding:10px;background:var(--bg);border:0;color:var(--t3);font-size:12.5px;font-weight:500;cursor:pointer;transition:.15s;text-align:center}
.utab:not(:last-child){border-right:1px solid var(--border)}
.utab.on{background:var(--elevated);color:var(--t1)}
.utab:hover:not(.on){color:var(--t2)}
.dropzone{border:2px dashed var(--border);border-radius:12px;padding:40px 20px;text-align:center;cursor:pointer;transition:.25s;position:relative}
.dropzone:hover,.dropzone.drag{border-color:var(--accent);background:rgba(232,89,12,.04)}
.dropzone.drag{transform:scale(1.01)}
.dz-icon{font-size:36px;margin-bottom:10px}
.dz-main{color:var(--t2);font-size:13px;margin-bottom:4px}
.dz-sub{color:var(--t3);font-size:11px}
.dz-file{display:flex;align-items:center;gap:8px;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 14px;margin-top:14px;text-align:left}
.dz-fname{font-family:var(--mono);font-size:12px;color:var(--t1);flex:1}
.dz-fsize{font-size:11px;color:var(--t3)}
.dz-remove{background:0;border:0;color:var(--t3);cursor:pointer;font-size:14px;padding:2px}
.dz-remove:hover{color:var(--fail)}
.ai-progress{margin-top:16px;padding:16px;background:var(--bg);border:1px solid var(--border);border-radius:8px}
.ai-step{display:flex;align-items:center;gap:8px;padding:5px 0;font-size:12px;color:var(--t3)}
.ai-step.active{color:var(--accent)}
.ai-step.done{color:var(--pass)}
.ai-step .check{width:16px;text-align:center}
.ai-preview{margin-top:16px}
.ai-preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.ai-preview-header span{font-size:11px;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;font-weight:500}
.ai-json{width:100%;min-height:220px;max-height:380px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--t1);padding:12px;font-family:var(--mono);font-size:11px;line-height:1.6;outline:0;resize:vertical}
.ai-json:focus{border-color:var(--accent)}
.ai-actions{display:flex;gap:8px;margin-top:12px}
.ai-actions button{flex:1}
.abtn-primary{padding:11px;background:linear-gradient(135deg,var(--accent),#c2410c);border:0;border-radius:7px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;transition:.15s}
.abtn-primary:hover{transform:translateY(-1px)}
.abtn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none}
.abtn-secondary{padding:11px;background:var(--elevated);border:1px solid var(--border);border-radius:7px;color:var(--t2);font-size:13px;font-weight:500;cursor:pointer;transition:.15s}
.abtn-secondary:hover{border-color:var(--accent);color:var(--accent)}
.ai-error{margin-top:12px;padding:10px 14px;background:var(--fail-bg);border:1px solid var(--fail-b);border-radius:7px;color:var(--fail);font-size:12px}
.multi-entries{margin-top:12px}
.entry-tab{display:inline-flex;align-items:center;gap:4px;padding:5px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--t3);font-size:11px;cursor:pointer;margin-right:4px;margin-bottom:4px;transition:.15s}
.entry-tab.on{background:var(--elevated);color:var(--t1);border-color:var(--accent)}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<header class="hdr">
  <div class="logo">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
    <b>TDSP</b>
    <span>Test Data Standardization Platform</span>
  </div>
  <div class="nav" id="navBar"></div>
</header>

<main class="main">
  <div id="banner" style="display:none"></div>
  <div id="content"></div>
</main>

<div class="moverlay" id="uploadModal">
  <div class="modal">
    <div class="mhdr"><h3 id="modalTitle">í…ŒìŠ¤íŠ¸ ë°ì´í„° ë“±ë¡</h3><button class="mcls" onclick="closeModal()">âœ•</button></div>
    <div class="mbody" id="modalBody"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â• SCHEMA (Inline â€” data/schema.jsì™€ ë™ì¼ ë‚´ìš©) â•â•â•â•â•â•â•â•â•â•
var SCHEMA={version:'1.0',
  enums:{test_type:['Comparative','Performance','Functional','Reliability','Safety','EMC','Environmental','Other'],result_summary:['Pass','Fail','Conditional','Informational'],report_type:['Detailed Report','Monthly Report','Summary','Raw Data'],source_format:['PPT','Excel','Word']},
  layers:{
    common:{label:'Layer 1 â€” ê³µí†µ ìŠ¤í‚¤ë§ˆ (Common)',color:'var(--blue)',bg:'#0a1530',border:'#1e3a5f',desc:'ëª¨ë“  í…ŒìŠ¤íŠ¸ì— ê³µí†µ â€” ê²€ìƒ‰, í•„í„°ë§ì˜ ê¸°ì¤€.',fields:[
      {key:'test_id',type:'String (PK)',required:true,desc:'ê³ ìœ  í…ŒìŠ¤íŠ¸ ì‹ë³„ì',placeholder:'QB-FAN-2025-001',formType:'text'},
      {key:'project_name',type:'String',required:true,desc:'í”„ë¡œì íŠ¸ ëª…ì¹­',placeholder:'QB Project',formType:'text'},
      {key:'test_category',type:'String',required:true,desc:'í…ŒìŠ¤íŠ¸ ëª¨ë“ˆ/ì˜ì—­',placeholder:'Thermocycling Module',formType:'text',defaultValue:'Thermocycling Module'},
      {key:'test_type',type:'Enum',required:true,desc:'í…ŒìŠ¤íŠ¸ ìœ í˜•',formType:'select',enumKey:'test_type'},
      {key:'test_date',type:'Date',required:true,desc:'YYYY-MM-DD',formType:'date'},
      {key:'result_summary',type:'Enum',required:true,desc:'ê²°ê³¼ ìš”ì•½',formType:'select',enumKey:'result_summary'},
      {key:'engineer_name',type:'String',required:true,desc:'ë‹´ë‹¹ ì—”ì§€ë‹ˆì–´',placeholder:'Jongtack Byeon',formType:'text'},
      {key:'report_type',type:'Enum',required:false,desc:'ë¦¬í¬íŠ¸ ìœ í˜•',formType:'select',enumKey:'report_type'},
      {key:'project_phase',type:'String',required:false,desc:'í”„ë¡œì íŠ¸ ë‹¨ê³„',placeholder:'Beta1',formType:'text'},
      {key:'original_files',type:'Array<String>',required:false,desc:'ì›ë³¸ íŒŒì¼ëª… (ì‰¼í‘œ êµ¬ë¶„)',placeholder:'Report.pptx',formType:'text'},
      {key:'source_format',type:'String',required:false,desc:'ì›ë³¸ í¬ë§·',formType:'select',enumKey:'source_format'},
      {key:'tags',type:'Array<String>',required:false,desc:'ê²€ìƒ‰ìš© íƒœê·¸ (ì‰¼í‘œ êµ¬ë¶„)',placeholder:'fan-noise, MHS',formType:'text'},
      {key:'notes',type:'Text',required:false,desc:'í•µì‹¬ ê²°ë¡  ë° íŠ¹ì´ì‚¬í•­',placeholder:'',formType:'textarea'},
      {key:'schema_version',type:'String',required:false,desc:'ìŠ¤í‚¤ë§ˆ ë²„ì „',formType:'hidden',defaultValue:'1.0'}
    ]},
    flexible:{label:'Layer 2 â€” ìœ ì—° ìŠ¤í‚¤ë§ˆ (Flexible)',color:'var(--purple)',bg:'#1a1230',border:'#581c87',desc:'ì¡´ì¬í•˜ë˜ ë‚´ë¶€ JSON êµ¬ì¡°ëŠ” ììœ .',fields:[
      {key:'dut_info',type:'JSON Object',required:false,desc:'Device Under Test ì •ë³´',placeholder:'{"module":"Thermocycling Module"}',formType:'json'},
      {key:'test_conditions',type:'JSON Object',required:false,desc:'í…ŒìŠ¤íŠ¸ ì¡°ê±´',placeholder:'{"unit_level":"Module"}',formType:'json'},
      {key:'measurements',type:'JSON Array',required:false,desc:'ì¸¡ì • ê²°ê³¼',placeholder:'[{"item":"Noise","value":52.61,"unit":"dB"}]',formType:'json-array'}
    ]},
    custom:{label:'Layer 3 â€” ì „ìš© ìŠ¤í‚¤ë§ˆ',color:'var(--accent)',bg:'#1f0f05',border:'#7c2d12',desc:'ëª¨ë“ˆë³„ ì „ìš© í•„ë“œ.'}
  },
  modules:{'Thermocycling Module':{label:'TCM',icon:'ğŸ”¥',fields:[
    {key:'evaluation_purpose',type:'String',desc:'í‰ê°€ ëª©ì '},{key:'evaluation_priority',type:'String',desc:'í‰ê°€ ìš°ì„ ìˆœìœ„'},
    {key:'pcr_protocol',type:'JSON Object',desc:'PCR í”„ë¡œí† ì½œ'},{key:'comparison_targets',type:'JSON Array',desc:'ë¹„êµ ëŒ€ìƒ'},
    {key:'design_factors',type:'JSON Object',desc:'ì„¤ê³„ ì¸ì'},{key:'statistical_analysis',type:'JSON Array',desc:'í†µê³„ ë¶„ì„'},
    {key:'simulation_results',type:'JSON Object',desc:'ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼'},{key:'failure_analysis',type:'JSON Object',desc:'ê³ ì¥ ë¶„ì„'},
    {key:'best_candidate',type:'String',desc:'ìµœì¢… í›„ë³´'},{key:'key_findings',type:'Array<String>',desc:'í•µì‹¬ ë°œê²¬ì‚¬í•­'}
  ]}},
  domains:{test_data:{label:'í…ŒìŠ¤íŠ¸ ë°ì´í„°',icon:'ğŸ§ª',active:true,desc:'í…ŒìŠ¤íŠ¸ ê²°ê³¼ í‘œì¤€í™” ë° ê´€ë¦¬'},
    project_management:{label:'í”„ë¡œì íŠ¸ ê´€ë¦¬',icon:'ğŸ“‹',active:false,desc:'í”„ë¡œì íŠ¸ ëª©ë¡, ë‹´ë‹¹ì í• ë‹¹, Issue ê´€ë¦¬'},
    report_management:{label:'ë¦¬í¬íŠ¸ ê´€ë¦¬',icon:'ğŸ“',active:false,desc:'Weekly/Monthly ë¦¬í¬íŠ¸ ê¸°ë¡ ë° ê´€ë¦¬'},
    meeting_management:{label:'ë¯¸íŒ… ê´€ë¦¬',icon:'ğŸ¤',active:false,desc:'ë¯¸íŒ… ê¸°ë¡, Action Items ì¶”ì '}}
};

// â•â•â•â•â•â•â•â•â•â• SCHEMA HELPERS â•â•â•â•â•â•â•â•â•â•
function buildFilterOptions(ek){return (SCHEMA.enums[ek]||[]).map(function(v){return '<option>'+v+'</option>'}).join('')}

function buildAIPrompt(){
  var l1=SCHEMA.layers.common.fields.filter(function(f){return f.formType!=='hidden'}).map(function(f){return '"'+f.key+'": "'+f.type+(f.required?' (required)':'')+' â€” '+f.desc+'"'}).join(',\n  ');
  var l2=SCHEMA.layers.flexible.fields.map(function(f){return '"'+f.key+'": "'+f.type+' â€” '+f.desc+'"'}).join(',\n  ');
  var l3='';for(var cat in SCHEMA.modules){var mod=SCHEMA.modules[cat];if(mod.disabled)continue;var flds=mod.fields.map(function(f){return '    "'+f.key+'": "'+f.type+' â€” '+f.desc+'"'}).join(',\n');l3+='\nFor '+cat+' tests, include "custom_fields" with ANY of these:\n{\n  "custom_fields": {\n'+flds+'\n  }\n}\n';}
  return 'You are a test data extraction assistant for TDSP. Extract structured test data using the 3-Layer schema. Return ONLY valid JSON.\n\n=== LAYER 1: COMMON ===\n{\n  '+l1+',\n  "schema_version": "'+SCHEMA.version+'"\n}\n\n=== LAYER 2: FLEXIBLE ===\n{\n  '+l2+'\n}\n\n=== LAYER 3: CUSTOM FIELDS ===\n'+l3+'\nRULES:\n- Use "Comparative" when comparing multiple designs/fans/conditions\n- Extract comparison tables into comparison_targets\n- Extract statistical data into statistical_analysis\n- Include speaker notes in notes (Korean OK)\n- Return ONLY valid JSON, no markdown fences';
}

function _mkField(f){var s='<div class="fg"><label class="fl">'+f.desc+(f.required?' *':'')+'</label>';if(f.formType==='select'){var opts=SCHEMA.enums[f.enumKey]||[];s+='<select class="fi" id="f_'+f.key+'" '+(f.required?'required':'')+'><option value="">ì„ íƒ</option>'+opts.map(function(o){return '<option>'+o+'</option>'}).join('')+'</select>';}else if(f.formType==='date'){s+='<input type="date" class="fi" id="f_'+f.key+'" '+(f.required?'required':'')+'>';}else{s+='<input class="fi" id="f_'+f.key+'" placeholder="'+(f.placeholder||'')+'" '+(f.required?'required':'')+' '+(f.defaultValue?'value="'+f.defaultValue+'"':'')+'>';}return s+'</div>';}

function buildManualFormHTML(){
  var h='';var fields=SCHEMA.layers.common.fields;var buf=[];
  for(var i=0;i<fields.length;i++){var f=fields[i];if(f.formType==='hidden')continue;if(f.formType==='textarea'){if(buf.length){h+='<div class="frow">'+buf.map(_mkField).join('')+'</div>';buf=[];}h+='<div class="fg"><label class="fl">'+f.desc+(f.required?' *':'')+'</label><textarea class="fta" id="f_'+f.key+'" placeholder="'+(f.placeholder||'')+'" '+(f.required?'required':'')+'></textarea></div>';continue;}buf.push(f);if(buf.length===2){h+='<div class="frow">'+buf.map(_mkField).join('')+'</div>';buf=[];}}
  if(buf.length)h+='<div class="frow">'+buf.map(_mkField).join('')+'</div>';
  SCHEMA.layers.flexible.fields.forEach(function(f){h+='<div class="fg"><label class="fl">'+f.desc+'</label>'+(f.type.indexOf('Array')>=0?'<textarea class="fta" id="f_'+f.key+"\" placeholder='"+(f.placeholder||'')+"'></textarea>":'<input class="fi" id="f_'+f.key+"\" style=\"font-family:var(--mono);font-size:11.5px\" placeholder='"+(f.placeholder||'')+"'>")+' </div>';});
  h+='<div class="fg"><label class="fl" style="color:var(--accent)">Custom Fields (JSON)</label><textarea class="fta" id="f_custom_fields" style="min-height:90px" placeholder=\'{"evaluation_purpose":"...","key_findings":[...]}\'></textarea></div>';
  return h;
}

function collectFormData(){
  var entry={};SCHEMA.layers.common.fields.forEach(function(f){var el=document.getElementById('f_'+f.key);if(!el){if(f.defaultValue)entry[f.key]=f.defaultValue;return;}var val=el.value.trim();if(f.type.indexOf('Array')>=0&&typeof val==='string')val=val.split(',').map(function(s){return s.trim()}).filter(Boolean);entry[f.key]=val||f.defaultValue||'';});
  SCHEMA.layers.flexible.fields.forEach(function(f){var el=document.getElementById('f_'+f.key);if(!el)return;var raw=el.value.trim();try{entry[f.key]=raw?JSON.parse(raw):(f.type.indexOf('Array')>=0?[]:{});}catch(e){entry[f.key]=f.type.indexOf('Array')>=0?[]:{}}});
  var cfEl=document.getElementById('f_custom_fields');if(cfEl&&cfEl.value.trim()){try{entry.custom_fields=JSON.parse(cfEl.value.trim())}catch(e){entry.custom_fields={}}}
  return entry;
}

function renderCustomFieldsDetail(d){
  if(!d.custom_fields||!Object.keys(d.custom_fields).length)return '';var cf=d.custom_fields;var h='<div class="dsec full" style="background:#1f0f05;border-color:#7c2d12"><div class="stit" style="color:var(--accent)">Layer 3 â€” Custom Fields ('+(d.test_category||'TCM')+')</div>';
  if(cf.evaluation_purpose)h+='<div class="irow"><span class="ilbl">í‰ê°€ ëª©ì </span><span class="ival">'+esc(cf.evaluation_purpose)+'</span></div>';
  if(cf.evaluation_priority)h+='<div class="irow"><span class="ilbl">í‰ê°€ ìš°ì„ ìˆœìœ„</span><span class="ival" style="color:var(--accent)">'+esc(cf.evaluation_priority)+'</span></div>';
  if(cf.best_candidate)h+='<div class="irow"><span class="ilbl">ìµœì¢… í›„ë³´</span><span class="ival" style="color:var(--pass)">'+esc(cf.best_candidate)+'</span></div>';
  if((cf.comparison_targets||[]).length){h+='<div style="margin-top:12px"><div style="font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px">ë¹„êµ ëŒ€ìƒ ('+cf.comparison_targets.length+'ê±´)</div><table class="mtbl"><thead><tr><th>ì´ë¦„</th><th>ì¹´í…Œê³ ë¦¬</th><th>ê²°ê³¼</th><th>ë¼ë²¨</th></tr></thead><tbody>';cf.comparison_targets.forEach(function(ct){var res=ct.results?Object.entries(ct.results).slice(0,3).map(function(e){return e[0]+': '+e[1]}).join(', '):'';h+='<tr><td style="color:var(--t1)">'+esc(ct.name||'')+'</td><td style="color:var(--t3)">'+esc(ct.category||'')+'</td><td style="font-family:var(--mono);font-size:10px;color:var(--t2)">'+res+'</td><td style="color:var(--accent)">'+esc(ct.label||'')+'</td></tr>';});h+='</tbody></table></div>';}
  if((cf.statistical_analysis||[]).length){h+='<div style="margin-top:12px"><div style="font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px">í†µê³„ ë¶„ì„</div><table class="mtbl"><thead><tr><th>Factor</th><th>r</th><th>RÂ²</th><th>p-value</th></tr></thead><tbody>';cf.statistical_analysis.forEach(function(s){h+='<tr><td style="color:var(--t1)">'+esc(s.factor||'')+'</td><td style="font-family:var(--mono);font-size:11px">'+(s.r!=null?s.r:'')+'</td><td style="font-family:var(--mono);font-size:11px">'+(s.R2!=null?s.R2:'')+'</td><td style="font-family:var(--mono);font-size:11px;color:'+(s.p_value<0.05?'var(--pass)':'var(--t3)')+'">'+(s.p_value!=null?s.p_value:'')+'</td></tr>';});h+='</tbody></table></div>';}
  if((cf.key_findings||[]).length){h+='<div style="margin-top:12px"><div style="font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px">í•µì‹¬ ë°œê²¬ì‚¬í•­</div>';cf.key_findings.forEach(function(f){h+='<div style="padding:4px 0;font-size:12px;color:var(--t2)">â€¢ '+esc(f)+'</div>';});h+='</div>';}
  return h+'</div>';
}

// â•â•â•â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•â•â•â•
let DATA=[], FILTERED=[], VIEW='dashboard', VMODE='grid';
let CFG={owner:'',repo:'',branch:'main',path:'data/tests.json',token:'',claude_key:''};
try{Object.assign(CFG,JSON.parse(localStorage.getItem('tdsp_cfg')||'{}'))}catch(e){}

// â•â•â•â•â•â•â•â•â•â• SAMPLE DATA â•â•â•â•â•â•â•â•â•â•
const SAMPLE=[
  {test_id:"QB-FAN-2025-001",project_name:"QB Project",test_category:"Thermocycling Module",test_type:"Comparative",test_date:"2025-04-11",result_summary:"Conditional",engineer_name:"Jongtack Byeon",report_type:"Detailed Report",project_phase:"Alpha",dut_info:{module:"Thermocycling Module",heatsink_design:"Original (Alpha)",fan_model:"614 J/2HHPR-010 (Original)"},test_conditions:{unit_level:"Module & System",software:"BlinkX 2.0 Control / Toolbox",protocol:"PCR w/o images & Temporary-made",pcr_cycles:40},measurements:[{item:"Noise Level (System)",value:"70-75",unit:"dB",condition:"Toolbox, PCR w/o images",verdict:"Fail"},{item:"Noise Level (Module, Original)",value:"20-30",unit:"PWM",condition:"BlinkX, Temporary",verdict:"Pass"},{item:"Operation Time Diff (Orion)",value:"+20-30",unit:"sec",condition:"Module level",verdict:"Pass"}],original_files:["20250411_1st_QB_Fan_Noise_Evaluation.pptx"],source_format:"PPT",tags:["fan-noise","Orion","Sanyo","original","system-vs-module"],notes:"Fan replacement shows clear cooling difference. Orion/Sanyo produce softer airflow sound. No significant impact on PCR performance.",schema_version:"1.0",custom_fields:{evaluation_purpose:"Study and evaluate cooling fan operational noise and verify effectiveness of alternative fans",evaluation_priority:"Noise â†’ Operation time â†’ Heatsink temperature",pcr_protocol:{targets:[{temp:95,hold_sec:2},{temp:60,hold_sec:5}],cycles:40,pre_heating:true},comparison_targets:[{name:"Original fan (614 J/2HHPR-010)",results:{noise:"lowest peak",behavior:"settles to PWM 20-30"}},{name:"Alternative#1 Orion",results:{noise:"softer airflow",behavior:"rapid cooling, fan stops cyclically"}},{name:"Alternative#2 Sanyo",results:{noise:"softer airflow",behavior:"similar to Orion, faster cycle"}}],key_findings:["Module vs System level shows different fan behavior","Software difference (BlinkX vs Toolbox) affects fan activation timing","Temperature saturation unstable with Toolbox"]}},
  {test_id:"QB-MHS-2025-002",project_name:"QB Project",test_category:"Thermocycling Module",test_type:"Comparative",test_date:"2025-05-30",result_summary:"Conditional",engineer_name:"Jongtack Byeon",report_type:"Detailed Report",project_phase:"Alpha",dut_info:{module:"Thermocycling Module",heatsink_designs:["Original","Original (by MHS)","MHS","MHS Extended"]},test_conditions:{unit_level:"Module",software:"BlinkX 2.0 Control",protocol:"PCR w/o images",pcr_cycles:40,pwm_control:"Feedback (automatic)"},measurements:[{item:"Operating Time (Original)",value:"27:22-27:30",unit:"mm:ss",condition:"Feedback control",verdict:"Pass"},{item:"Operating Time (MHS Extended)",value:"21:38-21:48",unit:"mm:ss",condition:"Feedback control",verdict:"Pass"},{item:"Noise (Original)",value:"64.28-66.81",unit:"dB",condition:"avg 21-40 cycles",verdict:"Conditional"},{item:"Noise (MHS)",value:"69.80-70.13",unit:"dB",condition:"avg 21-40 cycles",verdict:"Fail"},{item:"HS Temp (MHS Extended)",value:"41.13-41.47",unit:"degC",condition:"avg 21-40 cycles",verdict:"Pass"}],original_files:["20250530_MHS_Design_Evaluation.pptx"],source_format:"PPT",tags:["MHS","heatsink-design","heat-capacity","ramping-rate","PWM","airflow"],notes:"MHS design faster operating time despite higher HS temp. Interpreted as lower heat capacity effect enabling faster transient heat transfer.",schema_version:"1.0",custom_fields:{evaluation_purpose:"Evaluate MHS heatsink design and identify correlation between design elements",comparison_targets:[{name:"Original",category:"Standard heatsink",results:{op_time:"0:27:22-0:27:30",hs_temp_degC:"45.95-46.64",noise_dB:"64.28-66.81",pwm_pct:"59.22-64.02"}},{name:"MHS",category:"Sheet metal heatsink",results:{op_time:"0:22:34-0:22:52",hs_temp_degC:"48.80-49.92",noise_dB:"69.80-70.13",pwm_pct:"74.53-77.63"}},{name:"MHS Extended",category:"Extended sheet metal",results:{op_time:"0:21:38-0:21:48",hs_temp_degC:"41.13-41.47",noise_dB:"67.89-68.55",pwm_pct:"80.27-85.17"}}],design_factors:{mhs_heat_capacity:"lower than Original",material:"sheet metal form, Al 2000+6000 series"},key_findings:["Lower heat capacity enables faster ramping despite higher HS temp","PWM algorithm: initial ramp-up determines overall PWM behavior","MHS Extended most effective for noise reduction"]}},
  {test_id:"QB-TCM-2026-003",project_name:"QB Project",test_category:"Thermocycling Module",test_type:"Comparative",test_date:"2026-02-10",result_summary:"Conditional",engineer_name:"Jongtack Byeon",report_type:"Monthly Report",project_phase:"Beta1",dut_info:{module:"Thermocycling Module",heatsink_design:"Fin Type",fan_candidates:["614 J/2HHPR-010","THB1224B-PM00","OD1238-24HHBVXE","DC1203824W2B-BT0"]},test_conditions:{unit_level:"Module",software:"BlinkX 2.0 Control",protocol:"PCR 95â†”60Â°C",pcr_cycles:40,pwm_levels:["PWM30","PWM40","PWM50"],evaluation_method:"CFD Simulation + Actual Test"},measurements:[{item:"Noise (Fan1 Original)",value:54.08,unit:"dB",condition:"Actual avg",verdict:"Conditional"},{item:"Noise (Fan3 OD1238)",value:52.61,unit:"dB",condition:"Actual avg",verdict:"Pass"},{item:"HS Temp (Fan2 THB1224B)",value:42.25,unit:"degC",condition:"Actual avg",verdict:"Pass"},{item:"OP Time (Fan4 DC1203824)",value:"0:23:00",unit:"hh:mm:ss",condition:"Actual avg",verdict:"Pass"}],original_files:["20260210_PBK_R_D_Monthly_Report_Test_Activities.pptx"],source_format:"PPT",tags:["fan-selection","CFD","simulation","fin-type","noise","static-pressure"],notes:"Fan 1 (Original) best balanced. Fan 3 lowest noise but backflow risk. Flow Simulation model NOT suitable for fan factor prediction in actual conditions.",schema_version:"1.0",custom_fields:{evaluation_purpose:"Select optimal cooling fan for Fin-Type heatsink via CFD screening + actual test",evaluation_priority:"Noise â†’ Operation time â†’ Heatsink temperature",comparison_targets:[{name:"Fan 1 - 614 J/2HHPR-010 (Original)",category:"60mm",results:{sim_hs_temp:48.96,actual_noise_dB:54.08,actual_hs_temp:54.17,actual_op_time:"0:24:11"},label:"Best balanced"},{name:"Fan 2 - THB1224B-PM00",category:"120mm",results:{sim_hs_temp:45.04,actual_noise_dB:64.37,actual_hs_temp:42.25,actual_op_time:"0:23:22"},label:"Best cooling"},{name:"Fan 3 - OD1238-24HHBVXE",category:"120mm",results:{sim_hs_temp:44.58,actual_noise_dB:52.61,actual_hs_temp:53.80,actual_op_time:"0:23:07"},label:"Best low noise"},{name:"Fan 4 - DC1203824W2B-BT0",category:"120mm",results:{sim_hs_temp:52.15,actual_noise_dB:58.86,actual_hs_temp:51.73,actual_op_time:"0:23:00"},label:"Best fastest"}],simulation_results:{method:"Steady-State CFD",peltier_load_W:200,fan_count:9},statistical_analysis:[{factor:"Static Pressure",context:"Simulation",r:-0.748,R2:0.560,p_value:0.00001},{factor:"Static Pressure Ã— Airflow",context:"Simulation",r:-0.883,R2:0.779,p_value:0.00000},{factor:"Static Pressure Ã— Airflow",context:"Actual Test",r:-0.171,R2:0.029,p_value:0.596}],best_candidate:"Fan 1 (614 J/2HHPR-010) â€” best balanced",key_findings:["Flow Simulation model NOT suitable for actual fan factor prediction","Min Static Pressure ~2.1 inH2O needed to avoid backflow","Spec sheet fan parameters do not represent low PWM performance"]}}
];

// â•â•â•â•â•â•â•â•â•â• UTILS â•â•â•â•â•â•â•â•â•â•
const esc=s=>(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const badge=r=>{const c=r==='Pass'?'p':r==='Fail'?'f':'c';const ic=r==='Pass'?'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>':r==='Fail'?'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>':'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';return `<span class="bdg bdg-${c}">${ic} ${r}</span>`};
const fmtB=f=>{const c=f==='PPT'?'ppt':f==='Excel'?'xls':'doc';return `<span class="fmt fmt-${c}"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>${f}</span>`};
const vclr=v=>v==='Pass'?'var(--pass)':v==='Fail'?'var(--fail)':'var(--cond)';

function showBanner(type,msg){const b=document.getElementById('banner');b.className='banner '+(type==='ok'?'ok':type==='err'?'err':'info');b.innerHTML=msg;b.style.display='flex';setTimeout(()=>b.style.display='none',6000)}
function closeModal(){document.getElementById('uploadModal').classList.remove('show')}
function openModal(){document.getElementById('uploadModal').classList.add('show')}

// â•â•â•â•â•â•â•â•â•â• GITHUB API â•â•â•â•â•â•â•â•â•â•
async function loadGitHub(){
  if(!CFG.owner||!CFG.repo){showBanner('info','GitHub ë¯¸ì„¤ì •. ìƒ˜í”Œ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. [ì„¤ì •]ì—ì„œ ì—°ê²°í•˜ì„¸ìš”.');DATA=[...SAMPLE];render();return}
  showBanner('info','<span class="spin"></span> GitHubì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
  try{
    const h={'Accept':'application/vnd.github.v3+json'};if(CFG.token)h['Authorization']='token '+CFG.token;
    const r=await fetch(`https://api.github.com/repos/${CFG.owner}/${CFG.repo}/contents/${CFG.path}?ref=${CFG.branch}&t=${Date.now()}`,{headers:h});
    if(!r.ok){if(r.status===404){showBanner('info','ë°ì´í„° íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”!');DATA=[]}else throw new Error(r.status)}
    else{const f=await r.json();DATA=JSON.parse(decodeURIComponent(escape(atob(f.content.replace(/\n/g,'')))));showBanner('ok',`âœ“ ${DATA.length}ê±´ ë¡œë“œ ì™„ë£Œ`)}
  }catch(e){showBanner('err','GitHub ì—°ë™ ì‹¤íŒ¨: '+e.message+'. ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©.');DATA=[...SAMPLE]}
  render();
}

async function saveGitHub(entry){
  if(!CFG.owner||!CFG.repo||!CFG.token){DATA.push(entry);render();showBanner('ok','âœ“ ë¡œì»¬ ì €ì¥ ì™„ë£Œ. GitHub ì—°ë™ì€ [ì„¤ì •]ì—ì„œ í† í° ì…ë ¥ í•„ìš”.');return true}
  try{
    const h={'Accept':'application/vnd.github.v3+json','Authorization':'token '+CFG.token,'Content-Type':'application/json'};
    let sha=null;
    try{const g=await fetch(`https://api.github.com/repos/${CFG.owner}/${CFG.repo}/contents/${CFG.path}?ref=${CFG.branch}`,{headers:h});if(g.ok){const x=await g.json();sha=x.sha;DATA=JSON.parse(decodeURIComponent(escape(atob(x.content.replace(/\n/g,'')))))}}catch(e){}
    DATA.push(entry);
    const body={message:`[TDSP] Add: ${entry.test_id}`,content:btoa(unescape(encodeURIComponent(JSON.stringify(DATA,null,2)))),branch:CFG.branch};
    if(sha)body.sha=sha;
    const p=await fetch(`https://api.github.com/repos/${CFG.owner}/${CFG.repo}/contents/${CFG.path}`,{method:'PUT',headers:h,body:JSON.stringify(body)});
    if(!p.ok)throw new Error(p.status);
    render();showBanner('ok',`âœ“ GitHub ì»¤ë°‹ ì™„ë£Œ: ${entry.test_id}`);return true;
  }catch(e){showBanner('err','GitHub ì €ì¥ ì‹¤íŒ¨: '+e.message);DATA.push(entry);render();return false}
}

// â•â•â•â•â•â•â•â•â•â• DOWNLOADS â•â•â•â•â•â•â•â•â•â•
function dlJSON(){
  const d=FILTERED.length?FILTERED:DATA;
  const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='tdsp_data.json';a.click();
}
function dlCSV(){
  const d=FILTERED.length?FILTERED:DATA;if(!d.length)return;
  const cols=['test_id','project_name','test_type','test_date','result_summary','engineer_name','source_format','notes','tags'];
  let csv=cols.join(',')+'\n';
  d.forEach(r=>{csv+=cols.map(c=>{let v=r[c];if(Array.isArray(v))v=v.join('; ');return `"${String(v||'').replace(/"/g,'""')}"`}).join(',')+'\n'});
  const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='tdsp_data.csv';a.click();
}
function dlSingle(id){
  const item=DATA.find(d=>d.test_id===id);if(!item)return;
  const blob=new Blob([JSON.stringify(item,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=id+'.json';a.click();
}

// â•â•â•â•â•â•â•â•â•â• FILTER â•â•â•â•â•â•â•â•â•â•
function filter(){
  const q=(document.getElementById('si')?.value||'').toLowerCase();
  const ft=document.getElementById('ft')?.value||'All';
  const fr=document.getElementById('fr')?.value||'All';
  FILTERED=DATA.filter(d=>{
    const mq=!q||d.project_name.toLowerCase().includes(q)||d.test_id.toLowerCase().includes(q)||(d.tags||[]).some(t=>t.toLowerCase().includes(q))||d.engineer_name.includes(q)||(d.notes||'').toLowerCase().includes(q)||(d.test_category||'').toLowerCase().includes(q)||(d.report_type||'').toLowerCase().includes(q);
    const mt=ft==='All'||d.test_type===ft;
    const mr=fr==='All'||d.result_summary===fr;
    return mq&&mt&&mr;
  });
  renderData();
}

// â•â•â•â•â•â•â•â•â•â• RENDER NAV â•â•â•â•â•â•â•â•â•â•
function renderNav(){
  const tabs=[
    {k:'dashboard',l:'ëŒ€ì‹œë³´ë“œ',i:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>'},
    {k:'schema',l:'ìŠ¤í‚¤ë§ˆ',i:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="5" rx="1"/><rect x="2" y="10" width="20" height="5" rx="1"/><rect x="2" y="17" width="20" height="5" rx="1"/></svg>'},
    {k:'arch',l:'ì•„í‚¤í…ì²˜',i:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="5" cy="12" r="3"/><circle cx="19" cy="12" r="3"/><line x1="8" y1="12" x2="16" y2="12"/></svg>'},
    {k:'config',l:'ì„¤ì •',i:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9"/></svg>'}
  ];
  document.getElementById('navBar').innerHTML=tabs.map(t=>`<button class="nbtn ${VIEW===t.k?'on':''}" onclick="switchView('${t.k}')">${t.i} ${t.l}</button>`).join('')+
  `<button class="ubtn" onclick="openUpload()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> ì—…ë¡œë“œ</button>`;
}

function switchView(v){VIEW=v;renderNav();render()}

// â•â•â•â•â•â•â•â•â•â• RENDER MAIN â•â•â•â•â•â•â•â•â•â•
function render(){
  FILTERED=[...DATA];
  const C=document.getElementById('content');
  if(VIEW==='dashboard')renderDashboard(C);
  else if(VIEW==='schema')renderSchema(C);
  else if(VIEW==='arch')renderArch(C);
  else if(VIEW==='config')renderConfig(C);
  else if(VIEW==='detail')renderDetail(C);
}

function renderDashboard(C){
  const tot=DATA.length,pas=DATA.filter(d=>d.result_summary==='Pass').length,fai=DATA.filter(d=>d.result_summary==='Fail').length,con=DATA.filter(d=>d.result_summary==='Conditional').length,prj=[...new Set(DATA.map(d=>d.project_name))].length;
  C.innerHTML=`
    <div class="stats">
      <div class="st"><div class="st-l">ì „ì²´ í…ŒìŠ¤íŠ¸</div><div class="st-v" style="color:var(--t2)">${tot}</div></div>
      <div class="st"><div class="st-l">Pass</div><div class="st-v" style="color:var(--pass)">${pas}</div></div>
      <div class="st"><div class="st-l">Fail</div><div class="st-v" style="color:var(--fail)">${fai}</div></div>
      <div class="st"><div class="st-l">Conditional</div><div class="st-v" style="color:var(--cond)">${con}</div></div>
      <div class="st"><div class="st-l">í”„ë¡œì íŠ¸</div><div class="st-v" style="color:var(--blue)">${prj}</div></div>
    </div>
    <div class="toolbar">
      <button class="dlbtn" onclick="dlJSON()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>JSON ë‹¤ìš´ë¡œë“œ</button>
      <button class="dlbtn" onclick="dlCSV()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>CSV ë‹¤ìš´ë¡œë“œ</button>
      <button class="dlbtn" onclick="loadGitHub()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53A4.48 4.48 0 0 0 12 7.5v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5"/></svg>GitHub ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div class="sbar">
      <div class="swrap"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg><input class="sinput" id="si" placeholder="í…ŒìŠ¤íŠ¸ ID, í”„ë¡œì íŠ¸ëª…, íƒœê·¸, ì—”ì§€ë‹ˆì–´ ê²€ìƒ‰..." oninput="filter()"></div>
      <select class="fsel" id="ft" onchange="filter()"><option value="All">ì „ì²´ ìœ í˜•</option>${buildFilterOptions('test_type')}</select>
      <select class="fsel" id="fr" onchange="filter()"><option value="All">ì „ì²´ ê²°ê³¼</option>${buildFilterOptions('result_summary')}</select>
      <div class="vtog"><button class="${VMODE==='grid'?'on':''}" onclick="VMODE='grid';filter()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg></button><button class="${VMODE==='list'?'on':''}" onclick="VMODE='list';filter()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/></svg></button></div>
    </div>
    <div class="rcnt" id="rcnt">${FILTERED.length}ê±´</div>
    <div id="dc"></div>`;
  renderData();
}

function renderData(){
  const dc=document.getElementById('dc');const rc=document.getElementById('rcnt');
  if(rc)rc.textContent=FILTERED.length+'ê±´ì˜ í…ŒìŠ¤íŠ¸ ë°ì´í„°';
  if(!dc)return;
  if(!FILTERED.length){dc.innerHTML='<div style="text-align:center;padding:50px;color:var(--t3)">ë°ì´í„° ì—†ìŒ</div>';return}
  if(VMODE==='grid'){
    dc.innerHTML=`<div class="cgrid">${FILTERED.map(d=>`
      <div class="tcard" onclick="showDetail('${d.test_id}')">
        <div class="ch"><div><div class="ct">${esc(d.test_id)}</div><div class="cs">${esc(d.project_name)}${d.test_category?' â€” '+esc(d.test_category):''}</div></div>${badge(d.result_summary)}</div>
        <div class="cm">${fmtB(d.source_format||'Word')}<span>${d.test_type}</span><span class="sep">Â·</span><span>${d.test_date}</span><span class="sep">Â·</span><span>${d.engineer_name}</span>${d.report_type?'<span class="sep">Â·</span><span style="color:var(--purple)">'+d.report_type+'</span>':''}</div>
        ${(d.measurements||[]).slice(0,2).map(m=>`<div class="mrow"><span>${m.item}</span><span class="mval" style="color:${vclr(m.verdict)}">${m.value} ${m.unit}</span></div>`).join('')}
        ${(d.measurements||[]).length>2?`<div style="font-size:10px;color:var(--t3);margin-top:2px">+${d.measurements.length-2} more</div>`:''}
        <div class="tags" style="margin-top:8px">${(d.tags||[]).slice(0,4).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
      </div>`).join('')}</div>`;
  }else{
    dc.innerHTML=`<div class="twrap"><table class="dtbl"><thead><tr><th>í…ŒìŠ¤íŠ¸ ID</th><th>í”„ë¡œì íŠ¸</th><th>ìœ í˜•</th><th>ë‚ ì§œ</th><th>ê²°ê³¼</th><th>ì›ë³¸</th><th>ì—”ì§€ë‹ˆì–´</th></tr></thead><tbody>${FILTERED.map(d=>`
      <tr onclick="showDetail('${d.test_id}')">
        <td style="font-family:var(--mono);font-size:12px;color:var(--t1)">${d.test_id}</td>
        <td style="color:var(--t3)">${d.project_name}</td>
        <td style="color:var(--t3)">${d.test_type}</td>
        <td style="color:var(--t3)">${d.test_date}</td>
        <td>${badge(d.result_summary)}</td>
        <td>${fmtB(d.source_format||'Word')}</td>
        <td style="color:var(--t3)">${d.engineer_name}</td>
      </tr>`).join('')}</tbody></table></div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â• DETAIL â•â•â•â•â•â•â•â•â•â•
let DETAIL_ID='';
function showDetail(id){DETAIL_ID=id;VIEW='detail';renderNav();render()}
function backToList(){VIEW='dashboard';renderNav();render()}

function renderDetail(C){
  const d=DATA.find(x=>x.test_id===DETAIL_ID);if(!d){backToList();return}
  C.innerHTML=`<div style="animation:fadeUp .3s ease">
    <button class="dbk" onclick="backToList()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>ëª©ë¡ìœ¼ë¡œ</button>
    <div class="dh"><h2>${esc(d.test_id)}</h2>${badge(d.result_summary)} ${fmtB(d.source_format||'Word')}
      <button class="dlbtn" onclick="dlSingle('${d.test_id}')" style="margin-left:auto"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="13" height="13"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>ë‹¤ìš´ë¡œë“œ</button>
    </div>
    <div class="dgrid">
      <div class="dsec"><div class="stit" style="color:var(--blue)">Layer 1 â€” ê¸°ë³¸ ì •ë³´</div>${[['í”„ë¡œì íŠ¸',d.project_name],['ì¹´í…Œê³ ë¦¬',d.test_category||'-'],['í…ŒìŠ¤íŠ¸ ìœ í˜•',d.test_type],['í…ŒìŠ¤íŠ¸ ë‚ ì§œ',d.test_date],['ë‹´ë‹¹ ì—”ì§€ë‹ˆì–´',d.engineer_name],['ë¦¬í¬íŠ¸ ìœ í˜•',d.report_type||'-'],['í”„ë¡œì íŠ¸ ë‹¨ê³„',d.project_phase||'-']].map(([l,v])=>`<div class="irow"><span class="ilbl">${l}</span><span class="ival">${esc(v||'')}</span></div>`).join('')}</div>
      <div class="dsec"><div class="stit" style="color:var(--purple)">Layer 2 â€” DUT ì •ë³´</div>${d.dut_info?Object.entries(d.dut_info).map(([k,v])=>`<div class="irow"><span class="ilbl">${k}</span><span class="ival m">${esc(typeof v==='object'?JSON.stringify(v):String(v))}</span></div>`).join(''):'<span class="ilbl">ì—†ìŒ</span>'}</div>
      <div class="dsec"><div class="stit" style="color:var(--purple)">Layer 2 â€” í…ŒìŠ¤íŠ¸ ì¡°ê±´</div>${d.test_conditions?Object.entries(d.test_conditions).map(([k,v])=>`<div class="irow"><span class="ilbl">${k}</span><span class="ival">${esc(typeof v==='object'?JSON.stringify(v):String(v))}</span></div>`).join(''):'<span class="ilbl">ì—†ìŒ</span>'}</div>
      <div class="dsec"><div class="stit">ì›ë³¸ íŒŒì¼</div>${(d.original_files||[]).map(f=>`<div class="flink"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>${esc(f)}</div>`).join('')}</div>
      ${(d.measurements||[]).length?`<div class="dsec full"><div class="stit" style="color:var(--purple)">Layer 2 â€” ì¸¡ì • ê²°ê³¼</div><table class="mtbl"><thead><tr><th>í•­ëª©</th><th>ì¸¡ì •ê°’</th><th>ë‹¨ìœ„</th><th>ì¡°ê±´</th><th>íŒì •</th></tr></thead><tbody>${d.measurements.map(m=>`<tr><td style="color:var(--t1)">${m.item||''}</td><td style="font-family:var(--mono);font-size:12px;color:var(--t1)">${m.value!=null?m.value:''}</td><td style="color:var(--t3)">${m.unit||''}</td><td style="color:var(--t2);font-size:11px">${m.condition||m.spec||''}</td><td>${m.verdict?badge(m.verdict):''}</td></tr>`).join('')}</tbody></table></div>`:''}
      ${renderCustomFieldsDetail(d)}
      <div class="dsec"><div class="stit">íƒœê·¸      </div>`:''}
      <div class="dsec"><div class="stit">íƒœê·¸</div><div class="tags">${(d.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}</div></div>
      <div class="dsec"><div class="stit">ë¹„ê³ </div><div class="ntxt">${esc(d.notes||'ì—†ìŒ')}</div></div>
    </div></div>`;
}

// â•â•â•â•â•â•â•â•â•â• SCHEMA â•â•â•â•â•â•â•â•â•â•
function renderSchema(C){
  const layers=[SCHEMA.layers.common, SCHEMA.layers.flexible];
  // Add active module as Layer 3
  for(const [cat,mod] of Object.entries(SCHEMA.modules)){
    if(!mod.disabled) layers.push({
      label:`Layer 3 â€” ${mod.label} ì „ìš© (custom_fields)`,
      color:SCHEMA.layers.custom.color, bg:SCHEMA.layers.custom.bg, border:SCHEMA.layers.custom.border,
      desc:`${cat} í…ŒìŠ¤íŠ¸ ì „ìš©. ë‹¤ë¥¸ ëª¨ë“ˆì€ ë‹¤ë¥¸ custom_fields ì‚¬ìš©.`,
      fields:mod.fields.map(f=>({key:'custom_fields.'+f.key,type:f.type,required:false,desc:f.desc}))
    });
  }
  C.innerHTML=layers.map(l=>{
    const flds=l.fields||[];
    return `<div class="dsec full" style="animation:fadeUp .4s ease;margin-bottom:14px;background:${l.bg};border-color:${l.border}">
    <div style="display:flex;align-items:center;gap:9px;margin-bottom:4px"><div style="width:8px;height:8px;border-radius:50%;background:${l.color}"></div><h3 style="font-family:var(--sans);font-size:15px;font-weight:700;color:${l.color}">${l.label}</h3></div>
    <div style="font-size:11px;color:var(--t3);margin-bottom:14px;margin-left:17px">${l.desc}</div>
    <table class="sctbl"><thead><tr><th>í•„ë“œëª…</th><th>íƒ€ì…</th><th>í•„ìˆ˜</th><th>ì„¤ëª…</th></tr></thead><tbody>${flds.map(f=>`<tr><td class="scf" style="color:${l.color}">${f.key}</td><td><span class="sct">${f.type}</span></td><td>${f.required?'<span class="scr">â—</span>':''}</td><td style="color:var(--t3)">${f.desc}</td></tr>`).join('')}</tbody></table></div>`;
  }).join('')+
  // Future domains preview
  `<div class="dsec full" style="margin-top:0"><div class="stit">ë¯¸ë˜ í™•ì¥ ë„ë©”ì¸ (Phase 2+)</div><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">${Object.values(SCHEMA.domains).map(d=>`<div style="padding:12px;background:var(--bg);border:1px solid ${d.active?'var(--pass-b)':'var(--border)'};border-radius:8px;opacity:${d.active?1:0.5}"><div style="font-size:14px;margin-bottom:4px">${d.icon} <span style="font-size:12px;font-weight:600;color:${d.active?'var(--pass)':'var(--t3)'}">${d.label}</span>${d.active?' <span style="font-size:9px;padding:1px 6px;background:var(--pass-bg);color:var(--pass);border-radius:3px">í™œì„±</span>':''}</div><div style="font-size:11px;color:var(--t3)">${d.desc}</div></div>`).join('')}</div></div>`+
  `<div class="dsec full" style="margin-top:14px;animation:fadeUp .4s ease .1s both"><div class="stit">JSON ìƒ˜í”Œ (3-Layer êµ¬ì¡°)</div><pre class="codeblock">${esc(JSON.stringify(SAMPLE[2],null,2))}</pre></div>`;
}

// â•â•â•â•â•â•â•â•â•â• ARCHITECTURE â•â•â•â•â•â•â•â•â•â•
function renderArch(C){
  C.innerHTML=`<div class="dsec full" style="animation:fadeUp .4s ease">
    <div style="display:flex;align-items:center;gap:9px;margin-bottom:20px"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><circle cx="5" cy="12" r="3"/><circle cx="19" cy="12" r="3"/><line x1="8" y1="12" x2="16" y2="12"/></svg><h3 style="font-family:var(--sans);font-size:17px;font-weight:700">ë°ì´í„° íŒŒì´í”„ë¼ì¸ & ì•„í‚¤í…ì²˜</h3></div>
    <div class="pflow">${[
      {i:'ğŸ“',t:'Upload',d:'PPT / Excel / Word<br>ë“œë˜ê·¸ ì•¤ ë“œë¡­',c:'var(--blue)'},
      {i:'ğŸ¤–',t:'AI Parse',d:'Claude API ìë™ íŒŒì‹±',c:'var(--accent)'},
      {i:'ğŸ”„',t:'Standardize',d:'JSON ìŠ¤í‚¤ë§ˆ ë§¤í•‘',c:'var(--purple)'},
      {i:'ğŸ’¾',t:'Store',d:'GitHub Repo',c:'var(--pass)'},
      {i:'ğŸŒ',t:'Access',d:'GitHub Pages',c:'#06b6d4'}
    ].map((s,i,a)=>`<div class="pstep"><div class="pico">${s.i}</div><div class="ptit" style="color:${s.c}">${s.t}</div><div class="pdsc">${s.d}</div></div>${i<a.length-1?'<div class="parr">â†’</div>':''}`).join('')}</div></div>
    <div class="agrid">${[
      {t:'Frontend â€” GitHub Pages',c:'var(--blue)',d:'ì •ì  HTMLì„ <code>GitHub Pages</code>ë¡œ í˜¸ìŠ¤íŒ…. ë¬´ë£Œ, ë³„ë„ ì„œë²„ ë¶ˆí•„ìš”.'},
      {t:'Data â€” GitHub Repository',c:'var(--pass)',d:'<code>data/tests.json</code>ì— ì €ì¥. Git ë²„ì „ ê´€ë¦¬ë¡œ ì´ë ¥ ì¶”ì .'},
      {t:'Upload â€” AI íŒŒì‹±',c:'var(--accent)',d:'PPT/Excelì„ ë“œë˜ê·¸ì•¤ë“œë¡­í•˜ë©´ <code>Claude API</code>ê°€ ìë™ìœ¼ë¡œ JSON ë³€í™˜. ìˆ˜ë™ ì…ë ¥ê³¼ JSON ë¶™ì—¬ë„£ê¸°ë„ ì§€ì›.'},
      {t:'Download â€” JSON/CSV',c:'var(--purple)',d:'í•„í„°ë§ëœ ë°ì´í„°ë¥¼ <code>JSON</code> ë˜ëŠ” <code>CSV</code>ë¡œ ë‹¤ìš´ë¡œë“œ.'}
    ].map(a=>`<div class="acard"><div class="atit" style="color:${a.c}">${a.t}</div><div class="adsc">${a.d}</div></div>`).join('')}</div>
    <div class="dsec full" style="margin-top:14px"><div class="stit">GitHub ì €ì¥ì†Œ êµ¬ì¡°</div><pre class="codeblock">tdsp-data/
â”œâ”€â”€ index.html          â† ì´ í”Œë«í¼ (GitHub Pages)
â”œâ”€â”€ data/
â”‚   â””â”€â”€ tests.json      â† í‘œì¤€í™”ëœ í…ŒìŠ¤íŠ¸ ë°ì´í„°
â”œâ”€â”€ raw/                â† ì›ë³¸ íŒŒì¼ ë³´ê´€ (ì„ íƒ)
â”‚   â”œâ”€â”€ Report_v1.pptx
â”‚   â””â”€â”€ Data.xlsx
â””â”€â”€ README.md</pre></div>
    <div class="dsec full" style="margin-top:14px"><div class="stit">ë°°í¬ ë°©ë²•</div><div style="color:var(--t2);font-size:13px;line-height:2">
      <b style="color:var(--t1)">1.</b> GitHubì— <code style="background:var(--bg);padding:1px 5px;border-radius:3px;font-family:var(--mono);font-size:11px;color:var(--accent)">tdsp-data</code> ì €ì¥ì†Œ ìƒì„±<br>
      <b style="color:var(--t1)">2.</b> ì´ HTMLì„ <code style="background:var(--bg);padding:1px 5px;border-radius:3px;font-family:var(--mono);font-size:11px;color:var(--accent)">index.html</code>ë¡œ push<br>
      <b style="color:var(--t1)">3.</b> Settings â†’ Pages â†’ Sourceë¥¼ <code style="background:var(--bg);padding:1px 5px;border-radius:3px;font-family:var(--mono);font-size:11px;color:var(--accent)">main</code>ìœ¼ë¡œ ì„¤ì •<br>
      <b style="color:var(--t1)">4.</b> <code style="background:var(--bg);padding:1px 5px;border-radius:3px;font-family:var(--mono);font-size:11px;color:var(--accent)">https://USERNAME.github.io/tdsp-data/</code> ì ‘ì† ê°€ëŠ¥<br>
      <b style="color:var(--t1)">5.</b> í”Œë«í¼ [ì„¤ì •]ì—ì„œ GitHub ì •ë³´ ì…ë ¥ â†’ ë°ì´í„° ì—°ë™ ì™„ë£Œ
    </div></div>`;
}

// â•â•â•â•â•â•â•â•â•â• CONFIG â•â•â•â•â•â•â•â•â•â•
function renderConfig(C){
  C.innerHTML=`<div class="csec"><div style="display:flex;align-items:center;gap:9px;margin-bottom:18px"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83"/></svg><h3 style="font-family:var(--sans);font-size:17px;font-weight:700">GitHub ì—°ë™ ì„¤ì •</h3></div>
    <label class="clbl">GitHub Username</label><input class="cinp" id="co" value="${esc(CFG.owner)}" placeholder="ì˜ˆ: jongtack-byeon">
    <label class="clbl">Repository Name</label><input class="cinp" id="cr" value="${esc(CFG.repo)}" placeholder="ì˜ˆ: tdsp-data">
    <label class="clbl">Branch</label><input class="cinp" id="cb" value="${esc(CFG.branch)}" placeholder="main">
    <label class="clbl">ë°ì´í„° íŒŒì¼ ê²½ë¡œ</label><input class="cinp" id="cp" value="${esc(CFG.path)}" placeholder="data/tests.json">
    <div class="chint">repo ë‚´ JSON ë°ì´í„° íŒŒì¼ì˜ ê²½ë¡œ</div>
    <label class="clbl">Personal Access Token (ì“°ê¸°ìš©, ì„ íƒ)</label><input class="cinp" id="ct" type="password" value="${esc(CFG.token)}" placeholder="ghp_xxxxxxxxxxxx">
    <div class="chint">GitHub â†’ Settings â†’ Developer settings â†’ Personal access tokens â†’ ê¶Œí•œ: <code style="background:var(--bg);padding:1px 5px;border-radius:3px;font-family:var(--mono);font-size:10px;color:var(--accent)">repo</code></div>
    <button class="cbtn" onclick="saveCfg()">ì„¤ì • ì €ì¥ ë° ì—°ê²° í…ŒìŠ¤íŠ¸</button></div>
  <div class="csec" style="margin-top:14px"><div style="display:flex;align-items:center;gap:9px;margin-bottom:18px"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--purple)" stroke-width="2"><path d="M12 2a5 5 0 0 1 5 5v3H7V7a5 5 0 0 1 5-5z"/><rect x="3" y="10" width="18" height="12" rx="2"/><circle cx="12" cy="16" r="1"/></svg><h3 style="font-family:var(--sans);font-size:17px;font-weight:700">Claude AI íŒŒì‹± ì„¤ì •</h3></div>
    <label class="clbl">Claude API Key (AI íŒŒì‹±ìš©)</label><input class="cinp" id="ck" type="password" value="${esc(CFG.claude_key)}" placeholder="sk-ant-api03-xxxxxxxxxxxx">
    <div class="chint">Anthropic Console â†’ API Keysì—ì„œ ë°œê¸‰. AI íŒŒì‹± ì—…ë¡œë“œ ê¸°ëŠ¥ì— í•„ìš”í•©ë‹ˆë‹¤. GitHub Pages ë°°í¬ ì‹œì—ë§Œ í•„ìš”í•˜ë©°, Claude.ai ë‚´ì—ì„œëŠ” ìë™ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.</div>
    <button class="cbtn" style="background:linear-gradient(135deg,var(--purple),#7c3aed)" onclick="saveCfg()">ì„¤ì • ì €ì¥</button></div>`;
}
function saveCfg(){
  CFG.owner=document.getElementById('co')?.value.trim()||CFG.owner;
  CFG.repo=document.getElementById('cr')?.value.trim()||CFG.repo;
  CFG.branch=(document.getElementById('cb')?.value.trim())||'main';
  CFG.path=(document.getElementById('cp')?.value.trim())||'data/tests.json';
  CFG.token=document.getElementById('ct')?.value.trim()||CFG.token;
  CFG.claude_key=document.getElementById('ck')?.value.trim()||CFG.claude_key;
  localStorage.setItem('tdsp_cfg',JSON.stringify(CFG));
  showBanner('ok','âœ“ ì„¤ì • ì €ì¥ ì™„ë£Œ');setTimeout(()=>loadGitHub(),300);
}

// â•â•â•â•â•â•â•â•â•â• UPLOAD â€” TABBED â•â•â•â•â•â•â•â•â•â•
let UPLOAD_TAB='ai';
let AI_FILES=[];
let AI_PARSED_ENTRIES=[];
let AI_CURRENT_IDX=0;

function openUpload(){
  UPLOAD_TAB='ai';AI_FILES=[];AI_PARSED_ENTRIES=[];AI_CURRENT_IDX=0;
  document.getElementById('modalTitle').textContent='í…ŒìŠ¤íŠ¸ ë°ì´í„° ë“±ë¡';
  renderUploadBody();
  openModal();
}

function renderUploadBody(){
  const mb=document.getElementById('modalBody');
  mb.innerHTML=`
    <div class="upload-tabs">
      <button class="utab ${UPLOAD_TAB==='ai'?'on':''}" onclick="UPLOAD_TAB='ai';renderUploadBody()">ğŸ¤– AI íŒŒì‹± ì—…ë¡œë“œ</button>
      <button class="utab ${UPLOAD_TAB==='manual'?'on':''}" onclick="UPLOAD_TAB='manual';renderUploadBody()">âœï¸ ìˆ˜ë™ ì…ë ¥</button>
      <button class="utab ${UPLOAD_TAB==='json'?'on':''}" onclick="UPLOAD_TAB='json';renderUploadBody()">ğŸ“‹ JSON ë¶™ì—¬ë„£ê¸°</button>
    </div>
    <div id="uploadContent"></div>`;
  const uc=document.getElementById('uploadContent');
  if(UPLOAD_TAB==='ai') renderAIUpload(uc);
  else if(UPLOAD_TAB==='manual') renderManualUpload(uc);
  else renderJSONImport(uc);
}

// â”€â”€ AI Upload Tab â”€â”€
function renderAIUpload(C){
  C.innerHTML=`
    <div class="dropzone" id="dropzone" onclick="document.getElementById('fileInput').click()"
         ondragover="event.preventDefault();this.classList.add('drag')"
         ondragleave="this.classList.remove('drag')"
         ondrop="event.preventDefault();this.classList.remove('drag');handleDrop(event)">
      <div class="dz-icon">ğŸ“‚</div>
      <div class="dz-main">PPT, Excel, Word íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒ</div>
      <div class="dz-sub">.pptx, .xlsx, .xlsm, .docx ì§€ì› Â· ìµœëŒ€ 50MB</div>
      <input type="file" id="fileInput" hidden accept=".pptx,.xlsx,.xlsm,.xls,.docx" multiple onchange="handleFileSelect(event)">
    </div>
    <div id="fileList"></div>
    <div id="aiArea"></div>`;
}

function handleDrop(e){
  const files=[...e.dataTransfer.files].filter(f=>/\.(pptx|xlsx|xlsm|xls|docx)$/i.test(f.name));
  if(!files.length){showBanner('err','ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.');return}
  files.forEach(f=>{if(!AI_FILES.find(x=>x.name===f.name))AI_FILES.push(f)});
  renderFileList();
}

function handleFileSelect(e){
  [...e.target.files].forEach(f=>{if(!AI_FILES.find(x=>x.name===f.name))AI_FILES.push(f)});
  renderFileList();
}

function removeFile(idx){
  AI_FILES.splice(idx,1);
  renderFileList();
}

function renderFileList(){
  const fl=document.getElementById('fileList');
  if(!AI_FILES.length){fl.innerHTML='';document.getElementById('aiArea').innerHTML='';return}
  fl.innerHTML=AI_FILES.map((f,i)=>{
    const ext=f.name.split('.').pop().toLowerCase();
    const icon=ext==='pptx'?'ğŸŸ£':ext.startsWith('xls')?'ğŸŸ¢':'ğŸ”µ';
    const size=f.size>1048576?(f.size/1048576).toFixed(1)+'MB':(f.size/1024).toFixed(0)+'KB';
    return `<div class="dz-file"><span>${icon}</span><span class="dz-fname">${esc(f.name)}</span><span class="dz-fsize">${size}</span><button class="dz-remove" onclick="removeFile(${i})">âœ•</button></div>`;
  }).join('')+`<div style="margin-top:14px"><button class="abtn-primary" style="width:100%" onclick="startAIParsing()" id="aiStartBtn">ğŸ¤– AI íŒŒì‹± ì‹œì‘ (${AI_FILES.length}ê°œ íŒŒì¼)</button></div>`;
}

async function startAIParsing(){
  const btn=document.getElementById('aiStartBtn');
  btn.disabled=true;btn.textContent='íŒŒì‹± ì¤‘...';
  const area=document.getElementById('aiArea');
  AI_PARSED_ENTRIES=[];AI_CURRENT_IDX=0;

  for(let i=0;i<AI_FILES.length;i++){
    const file=AI_FILES[i];
    area.innerHTML=`<div class="ai-progress">
      <div style="font-size:13px;color:var(--t1);font-weight:600;margin-bottom:10px">ì²˜ë¦¬ ì¤‘: ${esc(file.name)} (${i+1}/${AI_FILES.length})</div>
      <div class="ai-step active" id="step1"><span class="check"><span class="spin"></span></span> íŒŒì¼ ë‚´ìš© ì¶”ì¶œ ì¤‘...</div>
      <div class="ai-step" id="step2"><span class="check">â—‹</span> Claude AI ë¶„ì„ ëŒ€ê¸°</div>
      <div class="ai-step" id="step3"><span class="check">â—‹</span> JSON ë³€í™˜ ëŒ€ê¸°</div>
    </div>`;

    try{
      // Step 1: Parse file
      const text=await parseFileContent(file);
      document.getElementById('step1').className='ai-step done';
      document.getElementById('step1').innerHTML='<span class="check">âœ“</span> íŒŒì¼ ë‚´ìš© ì¶”ì¶œ ì™„ë£Œ ('+Math.round(text.length/1000)+'K chars)';
      document.getElementById('step2').className='ai-step active';
      document.getElementById('step2').innerHTML='<span class="check"><span class="spin"></span></span> Claude AI ë¶„ì„ ì¤‘...';

      // Step 2: Call Claude API
      const json=await callClaudeForParsing(text,file.name);
      document.getElementById('step2').className='ai-step done';
      document.getElementById('step2').innerHTML='<span class="check">âœ“</span> Claude AI ë¶„ì„ ì™„ë£Œ';
      document.getElementById('step3').className='ai-step done';
      document.getElementById('step3').innerHTML='<span class="check">âœ“</span> JSON ë³€í™˜ ì™„ë£Œ';

      AI_PARSED_ENTRIES.push({filename:file.name,data:json,raw:JSON.stringify(json,null,2)});
    }catch(err){
      area.innerHTML+=`<div class="ai-error">âŒ ${esc(file.name)} ì²˜ë¦¬ ì‹¤íŒ¨: ${esc(err.message)}</div>`;
      AI_PARSED_ENTRIES.push({filename:file.name,data:null,error:err.message});
    }
  }

  // Show preview
  renderAIPreview(area);
}

// â”€â”€ File Parsing â”€â”€
async function parseFileContent(file){
  const ext=file.name.split('.').pop().toLowerCase();
  const buf=await file.arrayBuffer();
  if(ext==='pptx') return await parsePPTX(buf,file.name);
  if(ext==='xlsx'||ext==='xlsm'||ext==='xls') return parseXLSX(buf,file.name);
  if(ext==='docx') return await parseDOCX(buf,file.name);
  throw new Error('ì§€ì›í•˜ì§€ ì•ŠëŠ” í˜•ì‹: .'+ext);
}

async function parsePPTX(buf,name){
  const zip=await JSZip.loadAsync(buf);
  let output='[FILE: '+name+']\n\n';

  // Get slide count
  const slideFiles=Object.keys(zip.files).filter(f=>/^ppt\/slides\/slide\d+\.xml$/i.test(f)).sort((a,b)=>{
    const na=parseInt(a.match(/\d+/)[0]),nb=parseInt(b.match(/\d+/)[0]);return na-nb;
  });

  for(const sf of slideFiles){
    const num=sf.match(/\d+/)[0];
    const xml=await zip.file(sf).async('string');
    output+=`\n=== Slide ${num} ===\n`;
    output+=extractPPTXText(xml);

    // Check for notes
    const notesFile=`ppt/notesSlides/notesSlide${num}.xml`;
    if(zip.files[notesFile]){
      const nxml=await zip.file(notesFile).async('string');
      const notes=extractPPTXText(nxml);
      if(notes.trim()) output+=`\n[Speaker Notes]\n${notes}`;
    }
  }
  return output;
}

function extractPPTXText(xml){
  let text='';
  // Extract table data
  const tableRegex=/<a:tbl>([\s\S]*?)<\/a:tbl>/g;
  const rowRegex=/<a:tr[\s>]([\s\S]*?)<\/a:tr>/g;
  const cellRegex=/<a:tc[\s>]([\s\S]*?)<\/a:tc>/g;
  const textRegex=/<a:t>([\s\S]*?)<\/a:t>/g;

  let processed=xml;
  let tableMatch;
  const tables=[];

  while((tableMatch=tableRegex.exec(xml))!==null){
    const tableXml=tableMatch[1];
    const rows=[];
    let rowMatch;
    const rowRe=new RegExp(rowRegex.source,'g');
    while((rowMatch=rowRe.exec(tableXml))!==null){
      const cells=[];
      const cellRe=new RegExp(cellRegex.source,'g');
      let cellMatch;
      while((cellMatch=cellRe.exec(rowMatch[1]))!==null){
        const cellTexts=[];
        const tRe=new RegExp(textRegex.source,'g');
        let tMatch;
        while((tMatch=tRe.exec(cellMatch[1]))!==null) cellTexts.push(tMatch[1]);
        cells.push(cellTexts.join(' '));
      }
      rows.push(cells);
    }
    if(rows.length) tables.push(rows);
  }

  // Extract all text runs (non-table)
  const allText=[];
  const paraRegex=/<a:p[\s>]([\s\S]*?)<\/a:p>/g;
  let paraMatch;
  while((paraMatch=paraRegex.exec(xml))!==null){
    const runs=[];
    const tRe=new RegExp(textRegex.source,'g');
    let tMatch;
    while((tMatch=tRe.exec(paraMatch[1]))!==null) runs.push(tMatch[1]);
    if(runs.length) allText.push(runs.join(''));
  }

  text+=allText.join('\n')+'\n';

  // Add tables as formatted text
  tables.forEach((tbl,ti)=>{
    text+=`\n[Table ${ti+1}]\n`;
    tbl.forEach(row=>{text+=row.join(' | ')+'\n'});
  });

  return text;
}

function parseXLSX(buf,name){
  const wb=XLSX.read(buf,{type:'array',cellDates:true});
  let output='[FILE: '+name+']\n';
  output+='Sheets: '+wb.SheetNames.join(', ')+'\n';

  wb.SheetNames.forEach(sn=>{
    const ws=wb.Sheets[sn];
    const range=XLSX.utils.decode_range(ws['!ref']||'A1');
    const rows=range.e.r-range.s.r+1;
    const cols=range.e.c-range.s.c+1;
    output+=`\n=== Sheet: ${sn} (${rows} rows Ã— ${cols} cols) ===\n`;

    const json=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
    if(json.length===0) return;

    // Header
    output+='Headers: '+json[0].join(' | ')+'\n';

    if(rows<=50){
      // Small sheet: include all
      json.slice(1).forEach(row=>{output+=row.join(' | ')+'\n'});
    }else{
      // Large sheet: first 10 rows + summary
      output+='[First 10 rows of data]\n';
      json.slice(1,11).forEach(row=>{output+=row.join(' | ')+'\n'});
      output+=`\n[... ${rows-11} more rows ...]\n`;
      // Last 3 rows
      output+='[Last 3 rows]\n';
      json.slice(-3).forEach(row=>{output+=row.join(' | ')+'\n'});

      // Numeric column summaries
      const numCols=[];
      for(let c=0;c<cols;c++){
        const vals=json.slice(1).map(r=>parseFloat(r[c])).filter(v=>!isNaN(v));
        if(vals.length>rows*0.5){
          const min=Math.min(...vals),max=Math.max(...vals),avg=vals.reduce((a,b)=>a+b,0)/vals.length;
          numCols.push({col:json[0][c]||('Col'+c),min:min.toFixed(2),max:max.toFixed(2),avg:avg.toFixed(2),count:vals.length});
        }
      }
      if(numCols.length){
        output+='\n[Column Statistics]\n';
        numCols.forEach(c=>{output+=`${c.col}: min=${c.min}, max=${c.max}, avg=${c.avg}, count=${c.count}\n`});
      }
    }
  });
  return output;
}

async function parseDOCX(buf,name){
  const zip=await JSZip.loadAsync(buf);
  const docXml=await zip.file('word/document.xml')?.async('string');
  if(!docXml) return '[FILE: '+name+']\n(Could not read document content)';

  let output='[FILE: '+name+']\n\n';
  const textRegex=/<w:t[\s>][^>]*>([\s\S]*?)<\/w:t>|<w:t>([\s\S]*?)<\/w:t>/g;
  const paraRegex=/<w:p[\s>]([\s\S]*?)<\/w:p>/g;
  let paraMatch;
  while((paraMatch=paraRegex.exec(docXml))!==null){
    const texts=[];
    const tRe=new RegExp(textRegex.source,'g');
    let tMatch;
    while((tMatch=tRe.exec(paraMatch[1]))!==null) texts.push(tMatch[1]||tMatch[2]||'');
    if(texts.length) output+=texts.join('')+'\n';
  }
  return output;
}

// â”€â”€ Claude API Call â”€â”€
async function callClaudeForParsing(text,filename){
  const systemPrompt=buildAIPrompt();

  const truncated=text.length>80000?text.substring(0,80000)+'\n\n[TRUNCATED â€” original was '+text.length+' chars]':text;

  const headers={'Content-Type':'application/json'};
  if(CFG.claude_key){
    headers['x-api-key']=CFG.claude_key;
    headers['anthropic-dangerous-direct-browser-access']='true';
  }

  const resp=await fetch('https://api.anthropic.com/v1/messages',{
    method:'POST',
    headers,
    body:JSON.stringify({
      model:'claude-sonnet-4-20250514',
      max_tokens:4096,
      system:systemPrompt,
      messages:[{role:'user',content:`Extract test data from this file:\n\nFilename: ${filename}\n\n${truncated}`}]
    })
  });

  if(!resp.ok){
    const errBody=await resp.text();
    throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨ ('+resp.status+'): '+errBody.substring(0,200));
  }

  const data=await resp.json();
  const raw=data.content.map(c=>c.text||'').join('');
  const cleaned=raw.replace(/```json\s*/g,'').replace(/```\s*/g,'').trim();

  try{ return JSON.parse(cleaned) }
  catch(e){ throw new Error('JSON íŒŒì‹± ì‹¤íŒ¨: '+e.message+'\n\nAI ì‘ë‹µ:\n'+raw.substring(0,500)) }
}

// â”€â”€ AI Preview â”€â”€
function renderAIPreview(area){
  const valid=AI_PARSED_ENTRIES.filter(e=>e.data);
  const failed=AI_PARSED_ENTRIES.filter(e=>!e.data);

  if(!valid.length){
    area.innerHTML=`<div class="ai-error">ëª¨ë“  íŒŒì¼ì˜ íŒŒì‹±ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ Claude API Keyë¥¼ í™•ì¸í•˜ì„¸ìš”.</div>`;
    return;
  }

  // Flatten arrays
  const allEntries=[];
  valid.forEach(v=>{
    if(Array.isArray(v.data)) v.data.forEach(d=>allEntries.push(d));
    else allEntries.push(v.data);
  });

  AI_PARSED_ENTRIES=allEntries.map((d,i)=>({data:d,raw:JSON.stringify(d,null,2),idx:i}));
  AI_CURRENT_IDX=0;

  area.innerHTML=`
    <div class="ai-preview">
      <div class="ai-preview-header">
        <span>âœ… ${allEntries.length}ê±´ì˜ ë°ì´í„° ì¶”ì¶œ ì™„ë£Œ${failed.length?' ('+failed.length+'ê±´ ì‹¤íŒ¨)':''}</span>
      </div>
      ${allEntries.length>1?`<div class="multi-entries" id="entryTabs">${allEntries.map((d,i)=>`<button class="entry-tab ${i===0?'on':''}" onclick="switchEntry(${i})">${d.test_id||'Entry '+(i+1)}</button>`).join('')}</div>`:''}
      <div style="margin-top:10px;font-size:11px;color:var(--t3);margin-bottom:6px">ì•„ë˜ JSONì„ ê²€í† í•˜ê³  í•„ìš”ì‹œ ìˆ˜ì •í•˜ì„¸ìš”:</div>
      <textarea class="ai-json" id="aiJsonEdit">${esc(JSON.stringify(allEntries[0],null,2))}</textarea>
      <div class="ai-actions">
        <button class="abtn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
        ${allEntries.length>1?`<button class="abtn-primary" onclick="saveAllAIEntries()" style="background:linear-gradient(135deg,var(--purple),#7c3aed)">ğŸ“¦ ì „ì²´ ${allEntries.length}ê±´ ì €ì¥</button>`:''}
        <button class="abtn-primary" onclick="saveCurrentAIEntry()">ğŸ’¾ ì €ì¥</button>
      </div>
    </div>`;
}

function switchEntry(idx){
  // Save current edit
  const ta=document.getElementById('aiJsonEdit');
  if(ta) AI_PARSED_ENTRIES[AI_CURRENT_IDX].raw=ta.value;

  AI_CURRENT_IDX=idx;
  ta.value=AI_PARSED_ENTRIES[idx].raw;

  document.querySelectorAll('.entry-tab').forEach((t,i)=>t.className='entry-tab'+(i===idx?' on':''));
}

async function saveCurrentAIEntry(){
  const ta=document.getElementById('aiJsonEdit');
  try{
    const entry=JSON.parse(ta.value);
    await saveGitHub(entry);
    showBanner('ok',`âœ“ ì €ì¥ ì™„ë£Œ: ${entry.test_id}`);
    closeModal();
  }catch(e){
    showBanner('err','JSON í˜•ì‹ ì˜¤ë¥˜: '+e.message);
  }
}

async function saveAllAIEntries(){
  const btn=event.target;btn.disabled=true;btn.textContent='ì €ì¥ ì¤‘...';
  let saved=0,failed=0;

  // Save current edit back
  const ta=document.getElementById('aiJsonEdit');
  if(ta) AI_PARSED_ENTRIES[AI_CURRENT_IDX].raw=ta.value;

  for(const pe of AI_PARSED_ENTRIES){
    try{
      const entry=JSON.parse(pe.raw);
      if(!CFG.owner||!CFG.repo||!CFG.token){
        DATA.push(entry);saved++;
      }else{
        await saveGitHub(entry);saved++;
      }
    }catch(e){failed++}
  }

  render();
  showBanner('ok',`âœ“ ${saved}ê±´ ì €ì¥ ì™„ë£Œ${failed?' ('+failed+'ê±´ ì‹¤íŒ¨)':''}`);
  closeModal();
}

// â”€â”€ JSON Import Tab â”€â”€
function renderJSONImport(C){
  C.innerHTML=`
    <div style="font-size:12.5px;color:var(--t2);margin-bottom:12px">Claudeê°€ ìƒì„±í•œ JSONì„ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. ë‹¨ì¼ ê°ì²´ ë˜ëŠ” ë°°ì—´ ëª¨ë‘ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
    <textarea class="ai-json" id="jsonImportArea" placeholder='[
  {
    "test_id": "QB-PERF-2026-001",
    "project_name": "QB Project",
    "test_type": "Performance",
    "test_date": "2026-02-10",
    "result_summary": "Conditional",
    "engineer_name": "Jongtack Byeon",
    "measurements": [...],
    ...
  }
]'></textarea>
    <div style="margin-top:8px;font-size:11px;color:var(--t3)">Tip: Claude ëŒ€í™”ì—ì„œ íŒŒì¼ì„ ì²¨ë¶€í•˜ê³  "TDSP ìŠ¤í‚¤ë§ˆë¡œ JSON ë³€í™˜í•´ì¤˜"ë¼ê³  ìš”ì²­í•˜ì„¸ìš”.</div>
    <div class="ai-actions" style="margin-top:14px">
      <button class="abtn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
      <button class="abtn-primary" onclick="importJSON()">ğŸ“¥ Import</button>
    </div>`;
}

async function importJSON(){
  const ta=document.getElementById('jsonImportArea');
  try{
    let parsed=JSON.parse(ta.value);
    if(!Array.isArray(parsed)) parsed=[parsed];

    let saved=0;
    for(const entry of parsed){
      if(!entry.test_id){showBanner('err','test_idê°€ ì—†ëŠ” í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.');return}
      if(!CFG.owner||!CFG.repo||!CFG.token){
        DATA.push(entry);saved++;
      }else{
        await saveGitHub(entry);saved++;
      }
    }
    render();
    showBanner('ok',`âœ“ ${saved}ê±´ Import ì™„ë£Œ`);
    closeModal();
  }catch(e){
    showBanner('err','JSON íŒŒì‹± ì˜¤ë¥˜: '+e.message);
  }
}

// â”€â”€ Manual Upload Tab â”€â”€
function renderManualUpload(C){
  C.innerHTML=`<form onsubmit="submitData(event)">${buildManualFormHTML()}<button type="submit" class="fsub" id="sbtn">ë°ì´í„° ì €ì¥</button></form>`;
}

function tryJSON(s){try{return JSON.parse(s)}catch(e){return null}}

async function submitData(e){
  e.preventDefault();
  const btn=document.getElementById('sbtn');btn.disabled=true;btn.textContent='ì €ì¥ ì¤‘...';
  const entry=collectFormData();
  await saveGitHub(entry);
  closeModal();
}

// â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•
try{renderNav();loadGitHub()}catch(e){console.error('TDSP Init Error:',e);document.getElementById('content').innerHTML='<div style="padding:40px;text-align:center;color:var(--fail)">âš ï¸ í”Œë«í¼ ë¡œë”© ì˜¤ë¥˜: '+e.message+'<br><br><span style="color:var(--t3);font-size:12px">F12 â†’ Console íƒ­ì—ì„œ ìƒì„¸ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.</span></div>'}
</script>
</body>
</html>
